# Домашнее задание к занятию 5. «Elasticsearch»## Задача 1Используя Docker-образ [centos:7](https://hub.docker.com/_/centos) как базовый и [документацию по установке и запуску Elastcisearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html):- составьте Dockerfile-манифест для Elasticsearch,``- соберите Docker-образ и сделайте `push` в ваш docker.io-репозиторий,- запустите контейнер из получившегося образа и выполните запрос пути `/` c хост-машины.Требования к `elasticsearch.yml`:- данные `path` должны сохраняться в `/var/lib`,- имя ноды должно быть `netology_test`.```cluster.name: netology_testnode.name: netology_test_nodepath.data: /var/lib/elasticsearchnetwork.host: 0.0.0.0discovery.seed_hosts: ["localhost"]```В ответе приведите:- текст Dockerfile-манифеста,```FROM ubuntu:22.04RUN apt-get update && apt-get install -y wget gpg ca-certificatesRUN wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | \gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg && \echo "deb [trusted=yes signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://mirror.yandex.ru/mirrors/elastic/7/ stable main" | \tee /etc/apt/sources.list.d/elastic-7.x.listRUN apt-get update && apt-get install -y elasticsearchRUN mkdir -p /var/lib/elasticsearchCOPY elasticsearch.yml /etc/elasticsearch/RUN chown -R elasticsearch:elasticsearch /etc/elasticsearch /usr/share/elasticsearch /var/lib/elasticsearchEXPOSE 9200USER elasticsearchCMD ["/usr/share/elasticsearch/bin/elasticsearch"]```- ссылку на образ в репозитории dockerhub,	[dsa1891/elasticsearch](https://hub.docker.com/r/dsa1891/elasticsearch)- ответ `Elasticsearch` на запрос пути `/` в json-виде.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XGET http://localhost:9200/{  "name" : "netology_test_node",  "cluster_name" : "netology_test",  "cluster_uuid" : "_na_",  "version" : {    "number" : "7.17.9",    "build_flavor" : "default",    "build_type" : "deb",    "build_hash" : "ef48222227ee6b9e70e502f0f0daa52435ee634d",    "build_date" : "2023-01-31T05:34:43.305517834Z",    "build_snapshot" : false,    "lucene_version" : "8.11.1",    "minimum_wire_compatibility_version" : "6.8.0",    "minimum_index_compatibility_version" : "6.0.0-beta1"  },  "tagline" : "You Know, for Search"}```## Задача 2В этом задании вы научитесь:- создавать и удалять индексы,- изучать состояние кластера,- обосновывать причину деградации доступности данных.Ознакомьтесь с [документацией](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html) и добавьте в `Elasticsearch` 3 индекса в соответствии с таблицей:| Имя | Количество реплик | Количество шард ||-----|-------------------|-----------------|| ind-1| 0 | 1 || ind-2 | 1 | 2 || ind-3 | 2 | 4 |```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XPUT "http://localhost:9200/ind-1" -H "Content-Type: application/json" -d '{  "settings": {    "number_of_replicas": 0,    "number_of_shards": 1  }}'root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XPUT "http://localhost:9200/ind-2" -H "Content-Type: application/json" -d '{/localhost:9200/ind-2" -H "Content-Type: application/json" -d '{  "settings": {    "number_of_replicas": 1,    "number_of_shards": 2  }}'root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XPUT "http://localhost:9200/ind-3" -H "Content-Type: application/json" -d '{/localhost:9200/ind-3" -H "Content-Type: application/json" -d '{  "settings": {    "number_of_replicas": 2,    "number_of_shards": 4  }}'```Получите список индексов и их статусов, используя API, и **приведите в ответе** на задание.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XGET "http://localhost:9200/_cat/indices?v"elasticsearch# curl -XGET "http://localhost:9200/_cat/indices?v"health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   .geoip_databases 1WATbZOLTamGgKYzefFFZQ   1   0         43            0     40.8mb         40.8mbgreen  open   ind-1            7M1QtKQeRmujrTXW8lj2_g   1   0          0            0       226b           226byellow open   ind-3            Ec3m5OfbRaCFVA--tqfNiA   4   2          0            0       226b           226byellow open   ind-2            4PcfIPdpT0u_gSvJNU3S9w   2   1          0            0       452b           452b```Получите состояние кластера `Elasticsearch`, используя API.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XGET "http://localhost:9200/_cluster/health?pretty"{  "cluster_name" : "netology_test",  "status" : "yellow",  "timed_out" : false,  "number_of_nodes" : 1,  "number_of_data_nodes" : 1,  "active_primary_shards" : 10,  "active_shards" : 10,  "relocating_shards" : 0,  "initializing_shards" : 0,  "unassigned_shards" : 10,  "delayed_unassigned_shards" : 0,  "number_of_pending_tasks" : 0,  "number_of_in_flight_fetch" : 0,  "task_max_waiting_in_queue_millis" : 0,  "active_shards_percent_as_number" : 50.0}```Как вы думаете, почему часть индексов и кластер находятся в состоянии yellow?```У меня один сервер, при создании индексов было указано более одной реплики, поэтому часть реплик шардов отсутствуют, их негде разместить, что приводит к состоянию "yellow". ```Удалите все индексы.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XDELETE "http://localhost:9200/ind-1"curl -XDELETE "http://localhost:9200/ind-2"curl -XDELETE "http://localhost:9200/ind-3"root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XGET "http://localhost:9200/_cat/indices?v"health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   .geoip_databases 1WATbZOLTamGgKYzefFFZQ   1   0         43            0     40.8mb         40.8mb```## Задача 3В этом задании вы научитесь:- создавать бэкапы данных,- восстанавливать индексы из бэкапов.Создайте директорию `{путь до корневой директории с Elasticsearch в образе}/snapshots`.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# docker exec -it elasticsearch-container mkdir -p /tmp/snapshots```Используя API, [зарегистрируйте](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html#snapshots-register-repository) эту директорию как `snapshot repository` c именем `netology_backup`.**Приведите в ответе** запрос API и результат вызова API для создания репозитория.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XPUT "http://localhost:9200/_snapshot/netology_backup" -H "Content-Type: application/json" -d '{  "type": "fs",  "settings": {    "location": "/tmp/snapshots",    "compress": true  }}'{"acknowledged":true}```Создайте индекс `test` с 0 реплик и 1 шардом и **приведите в ответе** список индексов.[Создайте `snapshot`](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html) состояния кластера `Elasticsearch`.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XGET "http://localhost:9200/_cat/indices?v"health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.sizegreen  open   .geoip_databases 1WATbZOLTamGgKYzefFFZQ   1   0         43            0     40.8mb         40.8mbgreen  open   test             8Pc8acr8QLu9noO8NN06_g   1   0          0            0       226b           226b```**Приведите в ответе** список файлов в директории со `snapshot`.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# docker exec -it elasticsearch-container ls -lahR /tmp/snapshots//tmp/snapshots/:total 36Kdrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxrwxrwt 1 root          root          4.0K Sep 14 17:53 ..-rw-r--r-- 1 elasticsearch elasticsearch 1.4K Sep 14 18:02 index-0-rw-r--r-- 1 elasticsearch elasticsearch    8 Sep 14 18:02 index.latestdrwxr-xr-x 6 elasticsearch elasticsearch 4.0K Sep 14 18:02 indices-rw-r--r-- 1 elasticsearch elasticsearch 9.6K Sep 14 18:02 meta-x3EOiZvoQgmO8saWctHP9g.dat-rw-r--r-- 1 elasticsearch elasticsearch  455 Sep 14 18:02 snap-x3EOiZvoQgmO8saWctHP9g.dat/tmp/snapshots/indices:total 24Kdrwxr-xr-x 6 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..drwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 E2K-9gcBS3OQNN34ColLDgdrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 HXgSsfmtTDqy0pjc6pCS5Adrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 JsQ-8GRkSGOrozSwSj28dwdrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 MjtfXC40Ty2wL2n5yH2LCg/tmp/snapshots/indices/E2K-9gcBS3OQNN34ColLDg:total 16Kdrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 6 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..drwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 0-rw-r--r-- 1 elasticsearch elasticsearch  504 Sep 14 18:02 meta-ucjblIoBea_1irDT_fOZ.dat/tmp/snapshots/indices/E2K-9gcBS3OQNN34ColLDg/0:total 41Mdrwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __2ZFKc13lRJy93TwrdsX9jA-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __3t37ATRjT8mYazd7dDetAQ-rw-r--r-- 1 elasticsearch elasticsearch 2.1M Sep 14 18:02 __6algbsDSRaSrUjTw9eWixQ-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __7OSfRiQjQ6O0NRI0P7BbfA-rw-r--r-- 1 elasticsearch elasticsearch  562 Sep 14 18:02 __7_eORFbWRpWYzy45KHxj2Q-rw-r--r-- 1 elasticsearch elasticsearch   70 Sep 14 18:02 __C10zCA71RTqIgu7ARSTrXA-rw-r--r-- 1 elasticsearch elasticsearch 2.1M Sep 14 18:02 __F7jAfpyWRkCYiTmGLy4JNg-rw-r--r-- 1 elasticsearch elasticsearch  161 Sep 14 18:02 __FJFTUctSQoe5thvlqG3Gbw-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __HyelInt2QO6Zci6zgJ0P9g-rw-r--r-- 1 elasticsearch elasticsearch 1021 Sep 14 18:02 __Oi3veVEoRuKHYybSGdkwGg-rw-r--r-- 1 elasticsearch elasticsearch  158 Sep 14 18:02 __PK__ww7_Q9-MSyfPyV3Q1Q-rw-r--r-- 1 elasticsearch elasticsearch 2.1M Sep 14 18:02 __SPynDfT-RjWJAD0jnRN90w-rw-r--r-- 1 elasticsearch elasticsearch  192 Sep 14 18:02 __TQWuYi35QmGKr8VwIzK31Q-rw-r--r-- 1 elasticsearch elasticsearch  130 Sep 14 18:02 __T_rekfF-SUObFpDqoaCcAw-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __YQxR2vijRhSINB_TiRAFhA-rw-r--r-- 1 elasticsearch elasticsearch  316 Sep 14 18:02 __a2c5AH17T1W9yaK06L_nEg-rw-r--r-- 1 elasticsearch elasticsearch  724 Sep 14 18:02 __bGogx3lNTHGKObJwLqYFmw-rw-r--r-- 1 elasticsearch elasticsearch  320 Sep 14 18:02 __btdO-C_jTVWvsSKIa4ersw-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __fMi1I_3ZRIW7htNVvgtNoA-rw-r--r-- 1 elasticsearch elasticsearch 2.0M Sep 14 18:02 __hzbEu11zRPSPDZIlkV23oQ-rw-r--r-- 1 elasticsearch elasticsearch  102 Sep 14 18:02 __hzxTXaEfTNG23KfxoEqleg-rw-r--r-- 1 elasticsearch elasticsearch 4.1M Sep 14 18:02 __l8UN65FoQqSE1as3IyuLGw-rw-r--r-- 1 elasticsearch elasticsearch 1.1M Sep 14 18:02 __lR4XwaBNRJK6VErOwauCOQ-rw-r--r-- 1 elasticsearch elasticsearch  24M Sep 14 18:02 __mCL1DjluTnabdZ3WT1fMww-rw-r--r-- 1 elasticsearch elasticsearch 4.0M Sep 14 18:02 __nbJGzEDJTBWPxTDWAiVNIA-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __peUf8Z6SQiaXEa1Hi_pyOQ-rw-r--r-- 1 elasticsearch elasticsearch   73 Sep 14 18:02 __slSH9znbS7useh7aNoBfaw-rw-r--r-- 1 elasticsearch elasticsearch  405 Sep 14 18:02 __v8J1ZaWvQJqjnwKLXZXQbg-rw-r--r-- 1 elasticsearch elasticsearch 758K Sep 14 18:02 __x3zdIvE3QxKCytPaQHtdEQ-rw-r--r-- 1 elasticsearch elasticsearch 2.7K Sep 14 18:02 index-PJkU79FsQXe9HEm96XAPbA-rw-r--r-- 1 elasticsearch elasticsearch 2.6K Sep 14 18:02 snap-x3EOiZvoQgmO8saWctHP9g.dat/tmp/snapshots/indices/HXgSsfmtTDqy0pjc6pCS5A:total 16Kdrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 6 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..drwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 0-rw-r--r-- 1 elasticsearch elasticsearch  400 Sep 14 18:02 meta-usjblIoBea_1irDT_fOc.dat/tmp/snapshots/indices/HXgSsfmtTDqy0pjc6pCS5A/0:total 16Kdrwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..-rw-r--r-- 1 elasticsearch elasticsearch  442 Sep 14 18:02 index-jJV4JDAnQx6I_c7Mfj6Mcw-rw-r--r-- 1 elasticsearch elasticsearch  459 Sep 14 18:02 snap-x3EOiZvoQgmO8saWctHP9g.dat/tmp/snapshots/indices/JsQ-8GRkSGOrozSwSj28dw:total 16Kdrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 6 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..drwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 0-rw-r--r-- 1 elasticsearch elasticsearch  846 Sep 14 18:02 meta-uMjblIoBea_1irDT_fOV.dat/tmp/snapshots/indices/JsQ-8GRkSGOrozSwSj28dw/0:total 48Kdrwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..-rw-r--r-- 1 elasticsearch elasticsearch  479 Sep 14 18:02 __HQ-0UjXwQ0C7NJlCD9S1-A-rw-r--r-- 1 elasticsearch elasticsearch 8.2K Sep 14 18:02 __PEcWlDYxRsuneYqhdC-CCg-rw-r--r-- 1 elasticsearch elasticsearch 8.4K Sep 14 18:02 __lGyzcwVURnGoUuPDSdXINA-rw-r--r-- 1 elasticsearch elasticsearch  479 Sep 14 18:02 __utgZmna2TSuz5HjcfJQayg-rw-r--r-- 1 elasticsearch elasticsearch 1.1K Sep 14 18:02 index-6GrJkJGAS8yj3fXADsFM1w-rw-r--r-- 1 elasticsearch elasticsearch 1.1K Sep 14 18:02 snap-x3EOiZvoQgmO8saWctHP9g.dat/tmp/snapshots/indices/MjtfXC40Ty2wL2n5yH2LCg:total 16Kdrwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 6 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..drwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 0-rw-r--r-- 1 elasticsearch elasticsearch 1.1K Sep 14 18:02 meta-u8jblIoBea_1irDT_fOf.dat/tmp/snapshots/indices/MjtfXC40Ty2wL2n5yH2LCg/0:total 48Kdrwxr-xr-x 2 elasticsearch elasticsearch 4.0K Sep 14 18:02 .drwxr-xr-x 3 elasticsearch elasticsearch 4.0K Sep 14 18:02 ..-rw-r--r-- 1 elasticsearch elasticsearch  479 Sep 14 18:02 __Fo5wQOcjTi-4f803ZPdyCg-rw-r--r-- 1 elasticsearch elasticsearch 9.4K Sep 14 18:02 __eToHUlXPRDSr3J12vkRgFg-rw-r--r-- 1 elasticsearch elasticsearch 9.4K Sep 14 18:02 __vQm4dY3YRnyhLWhsJGS_lw-rw-r--r-- 1 elasticsearch elasticsearch  479 Sep 14 18:02 __wEZGOYrHSVyRCR06PL5xSQ-rw-r--r-- 1 elasticsearch elasticsearch 1.1K Sep 14 18:02 index-IeC7TeEZT7yPHZtoz1-gkw-rw-r--r-- 1 elasticsearch elasticsearch 1.1K Sep 14 18:02 snap-x3EOiZvoQgmO8saWctHP9g.dat```Удалите индекс `test` и создайте индекс `test-2`. **Приведите в ответе** список индексов.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XGET "http://localhost:9200/_cat/indices"yellow open test-2           Yo4ZBlgvRyC97Y_Xmj8B8Q 2 1  0 0   452b   452bgreen  open .geoip_databases 1WATbZOLTamGgKYzefFFZQ 1 0 43 0 40.8mb 40.8mb```[Восстановите](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html) состояниекластера `Elasticsearch` из `snapshot`, созданного ранее. **Приведите в ответе** запрос к API восстановления и итоговый список индексов.```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XPOST "http://localhost:9200/_snapshot/netology_backup/snapshot_1/_restore" -H "Content-Type: application/json" -d '{  "indices": "test"}'{"accepted":true}root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-05-elasticsearch# curl -XGET "http://localhost:9200/_cat/indices"yellow open test-2           Yo4ZBlgvRyC97Y_Xmj8B8Q 2 1  0 0   452b   452bgreen  open .geoip_databases 1WATbZOLTamGgKYzefFFZQ 1 0 43 0 40.8mb 40.8mbgreen  open test             pChiSVq6SzKGktPM2UaM4A 1 0  0 0   226b   226b```