# Домашнее задание к занятию 2. «SQL»## ВведениеПеред выполнением задания вы можете ознакомиться с [дополнительными материалами](https://github.com/netology-code/virt-homeworks/blob/virt-11/additional/README.md).## Задача 1Используя Docker, поднимите инстанс PostgreSQL (версию 12) c 2 volume, в который будут складываться данные БД и бэкапы.Приведите получившуюся команду или docker-compose-манифест.```bashroot@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# cat docker-compose.ymlversion: '3'services:  postgres:    image: postgres:12    container_name: postgres-container    environment:      POSTGRES_USER: user1      POSTGRES_PASSWORD: user1pass      POSTGRES_DB: user1db    volumes:      - postgres-data:/var/lib/postgresql/data      - postgres-backups:/backupsvolumes:  postgres-data:  postgres-backups:root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker compose up -d[+] Running 14/14 ⠿ postgres Pulled                                                                                                                                    48.9s   ⠿ 360eba32fa65 Pull complete                                                                                                                       24.7s   ⠿ 6987678f9780 Pull complete                                                                                                                       24.8s   ⠿ 42299245e905 Pull complete                                                                                                                       25.4s   ⠿ afcda32ad76a Pull complete                                                                                                                       25.6s   ⠿ 23d81c750666 Pull complete                                                                                                                       26.6s   ⠿ c7813914a8b7 Pull complete                                                                                                                       26.8s   ⠿ 876fecb4c432 Pull complete                                                                                                                       27.0s   ⠿ 0a8727713246 Pull complete                                                                                                                       27.1s   ⠿ 86ca3070eaaa Pull complete                                                                                                                       45.5s   ⠿ 8fe7c279224e Pull complete                                                                                                                       45.6s   ⠿ 9ee906c6c211 Pull complete                                                                                                                       45.6s   ⠿ 3baddb10b524 Pull complete                                                                                                                       45.7s   ⠿ 1d69d50e495e Pull complete                                                                                                                       45.8s[+] Running 4/4 ⠿ Network 06-db-02-sql_default            Created                                                                                                     0.1s ⠿ Volume "06-db-02-sql_postgres-backups"  Created                                                                                                     0.0s ⠿ Volume "06-db-02-sql_postgres-data"     Created                                                                                                     0.0s ⠿ Container postgres-container            Started                                                                                                     1.2sroot@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker psCONTAINER ID   IMAGE           COMMAND                  CREATED         STATUS         PORTS      NAMESff19e8683048   postgres:12     "docker-entrypoint.s…"   6 seconds ago   Up 4 seconds   5432/tcp   postgres-container```## Задача 2В БД из задачи 1: - создайте пользователя test-admin-user и БД test_db;```bashroot@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker exec -it postgres-container psql -U user1 -d user1dbpsql (12.16 (Debian 12.16-1.pgdg120+1))Type "help" for help.user1db=# CREATE USER test_admin_user WITH PASSWORD 'test-password';CREATE ROLEuser1db=# CREATE DATABASE test_db;CREATE DATABASEuser1db=# \l                             List of databases   Name    | Owner | Encoding |  Collate   |   Ctype    | Access privileges-----------+-------+----------+------------+------------+------------------- postgres  | user1 | UTF8     | en_US.utf8 | en_US.utf8 | template0 | user1 | UTF8     | en_US.utf8 | en_US.utf8 | =c/user1         +           |       |          |            |            | user1=CTc/user1 template1 | user1 | UTF8     | en_US.utf8 | en_US.utf8 | =c/user1         +           |       |          |            |            | user1=CTc/user1 test_db   | user1 | UTF8     | en_US.utf8 | en_US.utf8 | user1db   | user1 | UTF8     | en_US.utf8 | en_US.utf8 |(5 rows)```- в БД test_db создайте таблицу orders и clients (спeцификация таблиц ниже);```bashuser1db=# CREATE TABLE orders (    id serial PRIMARY KEY,    наименование varchar,    цена integer);CREATE TABLEuser1db=# CREATE TABLE clients (    id serial PRIMARY KEY,    фамилия varchar,    страна_проживания varchar,    заказ integer REFERENCES orders(id));CREATE TABLE```- предоставьте привилегии на все операции пользователю test-admin-user на таблицы БД test_db;```bashuser1db=# GRANT ALL PRIVILEGES ON DATABASE test_db TO test_admin_user;GRANTuser1db=# GRANT ALL PRIVILEGES ON TABLE orders, clients TO test_admin_user;GRANT```- создайте пользователя test-simple-user;```user1db=# CREATE USER test_simple_user WITH PASSWORD 'other_password';CREATE ROLE```- предоставьте пользователю test-simple-user права на SELECT/INSERT/UPDATE/DELETE этих таблиц БД test_db.```user1db=# GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE orders, clients TO test_simple_user;GRANT```Таблица orders:- id (serial primary key);- наименование (string);- цена (integer).Таблица clients:- id (serial primary key);- фамилия (string);- страна проживания (string, index);- заказ (foreign key orders).Приведите:- итоговый список БД после выполнения пунктов выше;```user1db=# \l+                                                                   List of databases   Name    | Owner | Encoding |  Collate   |   Ctype    |     Access privileges     |  Size   | Tablespace |                Description-----------+-------+----------+------------+------------+---------------------------+---------+------------+-------------------------------------------- postgres  | user1 | UTF8     | en_US.utf8 | en_US.utf8 |                           | 7977 kB | pg_default | default administrative connection database template0 | user1 | UTF8     | en_US.utf8 | en_US.utf8 | =c/user1                 +| 7833 kB | pg_default | unmodifiable empty database           |       |          |            |            | user1=CTc/user1           |         |            | template1 | user1 | UTF8     | en_US.utf8 | en_US.utf8 | =c/user1                 +| 7833 kB | pg_default | default template for new databases           |       |          |            |            | user1=CTc/user1           |         |            | test_db   | user1 | UTF8     | en_US.utf8 | en_US.utf8 | =Tc/user1                +| 7833 kB | pg_default |           |       |          |            |            | user1=CTc/user1          +|         |            |           |       |          |            |            | test_admin_user=CTc/user1 |         |            | user1db   | user1 | UTF8     | en_US.utf8 | en_US.utf8 |                           | 8121 kB | pg_default |(5 rows)```- описание таблиц (describe);```user1db=# \d orders                                    Table "public.orders"    Column    |       Type        | Collation | Nullable |              Default--------------+-------------------+-----------+----------+------------------------------------ id           | integer           |           | not null | nextval('orders_id_seq'::regclass) наименование | character varying |           |          | цена         | integer           |           |          |Indexes:    "orders_pkey" PRIMARY KEY, btree (id)Referenced by:    TABLE "clients" CONSTRAINT "clients_заказ_fkey" FOREIGN KEY ("заказ") REFERENCES orders(id)user1db=#user1db=# \d clients                                       Table "public.clients"      Column       |       Type        | Collation | Nullable |               Default-------------------+-------------------+-----------+----------+------------------------------------- id                | integer           |           | not null | nextval('clients_id_seq'::regclass) фамилия           | character varying |           |          | страна_проживания | character varying |           |          | заказ             | integer           |           |          |Indexes:    "clients_pkey" PRIMARY KEY, btree (id)Foreign-key constraints:    "clients_заказ_fkey" FOREIGN KEY ("заказ") REFERENCES orders(id)```- SQL-запрос для выдачи списка пользователей с правами над таблицами test_db;```user1db=# SELECT grantee, privilege_typeFROM information_schema.role_table_grantsWHERE table_name IN ('orders', 'clients')  AND table_schema = 'public';     grantee      | privilege_type------------------+---------------- user1            | INSERT user1            | SELECT user1            | UPDATE user1            | DELETE user1            | TRUNCATE user1            | REFERENCES user1            | TRIGGER test_admin_user  | INSERT test_admin_user  | SELECT test_admin_user  | UPDATE test_admin_user  | DELETE test_admin_user  | TRUNCATE test_admin_user  | REFERENCES test_admin_user  | TRIGGER test_simple_user | INSERT test_simple_user | SELECT test_simple_user | UPDATE test_simple_user | DELETE user1            | INSERT user1            | SELECT user1            | UPDATE user1            | DELETE user1            | TRUNCATE user1            | REFERENCES user1            | TRIGGER test_admin_user  | INSERT test_admin_user  | SELECT test_admin_user  | UPDATE test_admin_user  | DELETE test_admin_user  | TRUNCATE test_admin_user  | REFERENCES test_admin_user  | TRIGGER test_simple_user | INSERT test_simple_user | SELECT test_simple_user | UPDATE test_simple_user | DELETE```- список пользователей с правами над таблицами test_db.```user1db=# \dp orders                                   Access privileges Schema |  Name  | Type  |       Access privileges       | Column privileges | Policies--------+--------+-------+-------------------------------+-------------------+---------- public | orders | table | user1=arwdDxt/user1          +|                   |        |        |       | test_admin_user=arwdDxt/user1+|                   |        |        |       | test_simple_user=arwd/user1   |                   |(1 row)user1db=# \dp clients                                    Access privileges Schema |  Name   | Type  |       Access privileges       | Column privileges | Policies--------+---------+-------+-------------------------------+-------------------+---------- public | clients | table | user1=arwdDxt/user1          +|                   |        |         |       | test_admin_user=arwdDxt/user1+|                   |        |         |       | test_simple_user=arwd/user1   |                   |(1 row)```## Задача 3Используя SQL-синтаксис, наполните таблицы следующими тестовыми данными:Таблица orders|Наименование|цена||------------|----||Шоколад| 10 ||Принтер| 3000 ||Книга| 500 ||Монитор| 7000||Гитара| 4000|Таблица clients|ФИО|Страна проживания||------------|----||Иванов Иван Иванович| USA ||Петров Петр Петрович| Canada ||Иоганн Себастьян Бах| Japan ||Ронни Джеймс Дио| Russia||Ritchie Blackmore| Russia|Используя SQL-синтаксис:- вычислите количество записей для каждой таблицы.Приведите в ответе:    - запросы,```-- Для таблицы ordersSELECT COUNT(*) FROM orders;-- Для таблицы clientsSELECT COUNT(*) FROM clients;```	    - результаты их выполнения.```user1db=# SELECT COUNT(*) FROM orders; count-------     5(1 row)user1db=#user1db=# SELECT COUNT(*) FROM clients; count-------     5(1 row)```	## Задача 4Часть пользователей из таблицы clients решили оформить заказы из таблицы orders.Используя foreign keys, свяжите записи из таблиц, согласно таблице:|ФИО|Заказ||------------|----||Иванов Иван Иванович| Книга ||Петров Петр Петрович| Монитор ||Иоганн Себастьян Бах| Гитара |Приведите SQL-запросы для выполнения этих операций.Приведите SQL-запрос для выдачи всех пользователей, которые совершили заказ, а также вывод этого запроса. Подсказка: используйте директиву `UPDATE`.```user1db=# UPDATE clientsSET заказ = orders.idFROM ordersWHERE clients.фамилия IN ('Иванов Иван Иванович', 'Петров Петр Петрович', 'Иоганн Себастьян Бах')AND orders.наименование IN ('Книга', 'Монитор', 'Гитара');UPDATE 3user1db=#user1db=# SELECT фамилия, заказ FROM clients WHERE заказ IS NOT NULL;       фамилия        | заказ----------------------+------- Иванов Иван Иванович |     3 Петров Петр Петрович |     3 Иоганн Себастьян Бах |     3(3 rows)```## Задача 5Получите полную информацию по выполнению запроса выдачи всех пользователей из задачи 4 (используя директиву EXPLAIN).Приведите получившийся результат и объясните, что значат полученные значения.```user1db=# EXPLAIN SELECT фамилия, заказ FROM clients WHERE заказ IS NOT NULL;                        QUERY PLAN----------------------------------------------------------- Seq Scan on clients  (cost=0.00..18.10 rows=806 width=36)   Filter: ("заказ" IS NOT NULL)(2 rows)```EXPLAIN показывает план выполнения запроса:- "Seq Scan on clients": указыние на последовательное сканирование таблицы `clients`, значит каждая строка в таблице будет просматриваться последовательно для проверки условия.  - "cost=0.00..18.10": стоимость выполнения запроса заданная диапазоном.- "rows=806": количество строк удовлетворяющих условию запроса.- "width=36": здесь оценивается ширина (количество столбцов) в полученном наборе данных. - "Filter: ("заказ" IS NOT NULL)": говорит нам, что запрос включает в себя фильтрацию строк, где столбец "заказ" не равен NULL.- В скобках "(2 rows)" количество строк в результате после выполнения фильтра.План выполнения показал, что запрос последовательный по всей таблице `clients`, с выбором строк, где значение столбца "заказ" не NULL. Оценка стоимости выполнения запроса низкая, можно сказать что он будет быстро выполнен.## Задача 6Создайте бэкап БД test_db и поместите его в volume, предназначенный для бэкапов (см. задачу 1).Остановите контейнер с PostgreSQL, но не удаляйте volumes.Поднимите новый пустой контейнер с PostgreSQL.Восстановите БД test_db в новом контейнере.Приведите список операций, который вы применяли для бэкапа данных и восстановления. **Сохранил роли**```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker exec -it postgres-container pg_dumpall -U user1 --roles-only -f /backups/roles.sql```**Сделал полный бэкап**```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker exec -it postgres-container pg_dump -U user1 -F t -f /backups/user1db.tar user1db```**Забрал файлы**```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker cp postgres-container:/backups/roles.sql ./root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql#docker cp postgres-container:/backups/user1db.tar ./root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# tar -tvf user1db.tar-rw------- postgres/postgres 5463 2023-09-09 20:29 toc.dat-rw------- postgres/postgres  224 2023-09-09 20:29 2994.dat-rw------- postgres/postgres  106 2023-09-09 20:29 2992.dat-rw------- postgres/postgres 4921 2023-09-09 20:29 restore.sql```**Добавил в docker-compose еще один сервис и поднял второй контейнер**```version: '3'services:  postgres:    image: postgres:12    container_name: postgres-container    environment:      POSTGRES_USER: user1      POSTGRES_PASSWORD: user1pass      POSTGRES_DB: user1db    volumes:      - postgres-data:/var/lib/postgresql/data      - postgres-backups:/backups  postgres-recover:    image: postgres:12    container_name: postgres-container-recover    environment:      POSTGRES_USER: user1      POSTGRES_PASSWORD: user1pass      POSTGRES_DB: user1db_recover    volumes:      - postgres-data-recover:/var/lib/postgresql/data      - postgres-backups-recover:/backupsvolumes:  postgres-data:  postgres-backups:  postgres-data-recover:  postgres-backups-recover:``````root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker compose up -d --no-recreate postgres-recover[+] Running 3/3 ⠿ Volume "06-db-02-sql_postgres-backups-recover"  Created                                                                                 0.0s ⠿ Volume "06-db-02-sql_postgres-data-recover"     Created                                                                                 0.0s ⠿ Container postgres-container-recover            Started                                                                                 0.5sroot@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker psCONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS          PORTS                                       NAMES87b723c14986   postgres:12   "docker-entrypoint.s…"   5 seconds ago   Up 3 seconds    5432/tcp                                    postgres-container-recovera45817e7308c   postgres:12   "docker-entrypoint.s…"   22 hours ago    Up 19 minutes   0.0.0.0:5433->5432/tcp, :::5433->5432/tcp   postgres-container```**Восстановил роли, получил ошибку, т.к. роль user1 уже была после создания контейнера** ```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker exec -it postgres-container-recover psql -U user1 -d user1db_recover -f /backups/roles.sqlSETSETSETCREATE ROLEALTER ROLECREATE ROLEALTER ROLEpsql:/backups/roles.sql:18: ERROR:  role "user1" already existsALTER ROLE```**Проверил какие роли появились, всё корректно**```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker exec -it postgres-container-recover psql -U user1 -d user1db_new -c "SELECT rolname FROM pg_roles;"          rolname--------------------------- pg_monitor pg_read_all_settings pg_read_all_stats pg_stat_scan_tables pg_read_server_files pg_write_server_files pg_execute_server_program pg_signal_backend test_admin_user test_simple_user user1(11 rows)```**Восстановил базы**```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker exec -it postgres-container-recover pg_restore -U user1 -d user1db_new -Ft -v /backups/user1db.tarpg_restore: connecting to database for restorepg_restore: creating TABLE "public.clients"pg_restore: creating SEQUENCE "public.clients_id_seq"pg_restore: creating SEQUENCE OWNED BY "public.clients_id_seq"pg_restore: creating TABLE "public.orders"pg_restore: creating SEQUENCE "public.orders_id_seq"pg_restore: creating SEQUENCE OWNED BY "public.orders_id_seq"pg_restore: creating DEFAULT "public.clients id"pg_restore: creating DEFAULT "public.orders id"pg_restore: processing data for table "public.clients"pg_restore: processing data for table "public.orders"pg_restore: executing SEQUENCE SET clients_id_seqpg_restore: executing SEQUENCE SET orders_id_seqpg_restore: creating CONSTRAINT "public.clients clients_pkey"pg_restore: creating CONSTRAINT "public.orders orders_pkey"pg_restore: creating FK CONSTRAINT "public.clients clients_заказ_fkey"pg_restore: creating ACL "public.TABLE clients"pg_restore: creating ACL "public.TABLE orders"```**Подклчился к новой базе и выполнил селект**```root@t450s:/home/user1/devops-netology/virt-homeworks/06-db-02-sql# docker exec -it postgres-container-recover psql -U user1 -d user1db_newpsql (12.16 (Debian 12.16-1.pgdg120+1))Type "help" for help.user1db_new=# SELECT * FROM clients; id |       фамилия        | страна_проживания | заказ----+----------------------+-------------------+-------  4 | Ронни Джеймс Дио     | Russia            |  5 | Ritchie Blackmore    | Russia            |  1 | Иванов Иван Иванович | USA               |     3  2 | Петров Петр Петрович | Canada            |     3  3 | Иоганн Себастьян Бах | Japan             |     3(5 rows)```------